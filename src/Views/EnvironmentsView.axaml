<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:AvalonHttp.ViewModels.EnvironmentAggregate"
             xmlns:lucide="clr-namespace:LucideAvalonia;assembly=LucideAvalonia"
             xmlns:controls="clr-namespace:AvalonHttp.Controls"
             xmlns:behaviors="clr-namespace:AvalonHttp.Behaviors"
             x:DataType="vm:EnvironmentsViewModel"
             x:Class="AvalonHttp.Views.EnvironmentsView"
             HorizontalAlignment="Stretch"
             VerticalAlignment="Stretch">

    <UserControl.KeyBindings>
        <KeyBinding Gesture="Ctrl+S" Command="{Binding SaveEnvironmentCommand}" />
    </UserControl.KeyBindings>
    
    <Interaction.Behaviors>
        <behaviors:ClearFocusOnClickBehavior />
    </Interaction.Behaviors>
    
    <Grid ColumnDefinitions="280,*">

        <Border Grid.Column="0"
                Background="{DynamicResource BgSidebarBrush}"
                BorderBrush="{DynamicResource BorderColor}"
                BorderThickness="0,0,1,0">
            
            
            <DockPanel>
                <StackPanel DockPanel.Dock="Top" Margin="20,20,20,16" Spacing="12">
                    <Grid ColumnDefinitions="*,Auto">
                        <TextBlock Text="ENVIRONMENTS"
                                   Grid.Column="0"
                                   Foreground="{DynamicResource TextSecondary}"
                                   FontSize="11"
                                   FontWeight="SemiBold"
                                   LetterSpacing="1" />

                        <Button Grid.Column="1"
                                Classes="IconButton"
                                Command="{Binding CreateEnvironmentCommand}"
                                ToolTip.Tip="New Environment (Ctrl+N)">
                            <lucide:Lucide Icon="Plus"
                                           StrokeBrush="{DynamicResource TextSecondary}"
                                           Width="16" Height="16" />
                        </Button>
                    </Grid>
                </StackPanel>

                <Border DockPanel.Dock="Bottom"
                        Background="{DynamicResource BgElevated}"
                        BorderBrush="{DynamicResource BorderColor}"
                        BorderThickness="0,1,0,0"
                        Padding="16,12,16,24">

                    <Button Command="{Binding CreateEnvironmentCommand}"
                            Background="Transparent"
                            BorderBrush="{DynamicResource BorderColor}"
                            BorderThickness="1"
                            CornerRadius="6"
                            Padding="12,8"
                            HorizontalAlignment="Stretch"
                            Cursor="Hand">
                        <Grid ColumnDefinitions="Auto,*,Auto">
                            <TextBlock Grid.Column="0"
                                       Text="Add Environment"
                                       Foreground="{DynamicResource TextPrimary}"
                                       VerticalAlignment="Center"
                                       Margin="0,0,8,0" />
                        </Grid>
                    </Button>
                </Border>

                <ScrollViewer>
                    <ItemsControl ItemsSource="{Binding Environments}"
                                  Margin="12,0,12,12">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                
                                <Border CornerRadius="6"
                                        Padding="16,12"
                                        Margin="0,0,0,8"
                                        Cursor="Hand"
                                        Background="{DynamicResource BgMain}"
                                        BorderBrush="{DynamicResource BorderColor}"
                                        BorderThickness="1"
                                        Classes.active="{Binding IsActive}"
                                        Classes.selected="{Binding IsSelected}">
                                    
                                    <Border.Styles>
                                        <!-- Active Style (The one used for requests) -->
                                        <Style Selector="Border.active">
                                            <Setter Property="BorderBrush" Value="{DynamicResource AccentBrush}" />
                                            <Setter Property="BorderThickness" Value="1" />
                                            <Setter Property="BoxShadow" Value="0 0 8 0 #204CAF50" /> <!-- Glow effect -->
                                        </Style>

                                        <!-- Selected Style (The one being edited) -->
                                        <Style Selector="Border.selected">
                                            <Setter Property="Background" Value="#1A1F2E" /> 
                                            <Setter Property="BorderBrush" Value="{DynamicResource BorderColor}" /> <!-- Keep neutral border if not active -->
                                        </Style>

                                        <!-- Combined: Active AND Selected -->
                                        <Style Selector="Border.active.selected">
                                            <Setter Property="Background" Value="#1A1F2E" />
                                            <Setter Property="BorderBrush" Value="{DynamicResource AccentBrush}" />
                                            <Setter Property="BorderThickness" Value="2" />
                                        </Style>
                                    </Border.Styles>

                                    <Interaction.Behaviors>
                                        <EventTriggerBehavior EventName="Tapped">
                                            <InvokeCommandAction
                                                Command="{Binding $parent[UserControl].((vm:EnvironmentsViewModel)DataContext).SelectCommand}"
                                                CommandParameter="{Binding}" />
                                        </EventTriggerBehavior>
                                    </Interaction.Behaviors>

                                    <Grid RowDefinitions="Auto,Auto">
                                        <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto">

                                            <Panel Grid.Column="0" Margin="0,0,8,0" VerticalAlignment="Center">
                                                <lucide:Lucide Icon="GlobeLock"
                                                               Width="16" Height="16"
                                                               StrokeBrush="{DynamicResource AccentBrush}"
                                                               IsVisible="{Binding IsGlobal}" />
                                                <lucide:Lucide Icon="Globe"
                                                               Width="16" Height="16"
                                                               StrokeBrush="{DynamicResource TextSecondary}"
                                                               IsVisible="{Binding !IsGlobal}" />
                                            </Panel>


                                            
                                            <TextBox Grid.Column="1"
                                                     Text="{Binding Name}"
                                                     IsVisible="{Binding IsEditing}"
                                                     BorderBrush="{DynamicResource AccentBrush}"
                                                     BorderThickness="1"
                                                     Background="{DynamicResource BgElevated}"
                                                     Foreground="{DynamicResource TextPrimary}"
                                                     FontWeight="Medium"
                                                     FontSize="13"
                                                     CornerRadius="4"
                                                     Padding="6,4"
                                                     VerticalAlignment="Center">
                                                <TextBox.KeyBindings>
                                                    <KeyBinding Gesture="Enter" Command="{Binding FinishRenameCommand}" />
                                                    <KeyBinding Gesture="Escape" Command="{Binding CancelRenameCommand}" />
                                                </TextBox.KeyBindings>
                                                <Interaction.Behaviors>
                                                    <EventTriggerBehavior EventName="LostFocus">
                                                        <InvokeCommandAction Command="{Binding FinishRenameCommand}" />
                                                    </EventTriggerBehavior>
                                                </Interaction.Behaviors>
                                            </TextBox>

                                            
                                            <Grid Grid.Column="1"
                                                  IsVisible="{Binding !IsEditing}"
                                                  Background="Transparent"
                                                  ColumnDefinitions="*,Auto"
                                                  ColumnSpacing="8">
                                                <Interaction.Behaviors>
                                                    <EventTriggerBehavior EventName="DoubleTapped">
                                                        <InvokeCommandAction Command="{Binding StartRenameCommand}" />
                                                    </EventTriggerBehavior>
                                                </Interaction.Behaviors>
                                                <Grid.IsEnabled>
                                                    <Binding Path="!IsGlobal" />
                                                </Grid.IsEnabled>
                                                
                                                <TextBlock Grid.Column="0"
                                                           Text="{Binding Name}"
                                                           Foreground="{DynamicResource TextPrimary}"
                                                           FontWeight="Medium"
                                                           FontSize="13"
                                                           VerticalAlignment="Center" />

                                                
                                                <Border Grid.Column="1"
                                                        Width="6" Height="6"
                                                        CornerRadius="3"
                                                        Background="{DynamicResource AccentBrush}"
                                                        VerticalAlignment="Center"
                                                        IsVisible="{Binding IsDirty}"
                                                        ToolTip.Tip="Unsaved changes" />
                                            </Grid>

                                            
                                            <Button Grid.Column="2"
                                                    Classes="IconButton"
                                                    Padding="4"
                                                    IsVisible="{Binding !IsGlobal}">
                                                <lucide:Lucide Icon="Menu"
                                                               Width="16" Height="16"
                                                               StrokeBrush="{DynamicResource TextSecondary}" />

                                                <Button.Flyout>
                                                    <MenuFlyout>
                                                        
                                                        <MenuItem Header="Set Active"
                                                                  Command="{Binding SetActiveCommand}"
                                                                  IsVisible="{Binding !IsActive}">
                                                            <MenuItem.Icon>
                                                                <lucide:Lucide Icon="Check" Width="14" />
                                                            </MenuItem.Icon>
                                                        </MenuItem>
                                                        
                                                        <MenuItem Header="Rename"
                                                                  Command="{Binding StartRenameCommand}">
                                                            <MenuItem.Icon>
                                                                <lucide:Lucide Icon="Pencil" Width="14" />
                                                            </MenuItem.Icon>
                                                        </MenuItem>

                                                        <MenuItem Header="Duplicate"
                                                                  Command="{Binding DuplicateCommand}">
                                                            <MenuItem.Icon>
                                                                <lucide:Lucide Icon="Copy" Width="14" />
                                                            </MenuItem.Icon>
                                                        </MenuItem>
                                                        
                                                        <MenuItem Header="Revert"
                                                                  Command="{Binding RevertChangesCommand}"
                                                                  IsVisible="{Binding IsDirty}">
                                                            <MenuItem.Icon>
                                                                <lucide:Lucide Icon="Undo"></lucide:Lucide>
                                                            </MenuItem.Icon>
                                                        </MenuItem>

                                                        <Separator />

                                                        <MenuItem Header="Delete"
                                                                  Command="{Binding DeleteCommand}">
                                                            <MenuItem.Icon>
                                                                <lucide:Lucide Icon="Trash2" Width="14" />
                                                            </MenuItem.Icon>
                                                        </MenuItem>
                                                    </MenuFlyout>
                                                </Button.Flyout>
                                            </Button>
                                        </Grid>

                                        <TextBlock Grid.Row="1"
                                                   Text="{Binding VariablesCount, StringFormat='{}{0} variables'}"
                                                   Foreground="{DynamicResource TextMuted}"
                                                   FontSize="11"
                                                   Margin="24,4,0,0" />
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </DockPanel>
        </Border>

        <Grid Grid.Column="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <Border Grid.Row="0"
                    Background="{DynamicResource BgElevated}"
                    BorderBrush="{DynamicResource BorderColor}"
                    BorderThickness="0,0,0,1"
                    Padding="20,16">

                <Grid ColumnDefinitions="*,Auto">
                    <StackPanel Grid.Column="0">
                        <TextBlock Text="{Binding SelectedEnvironment.Name, FallbackValue='No Environment Selected'}"
                                   FontSize="16"
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource TextPrimary}" />
                        <TextBlock Text="Edit environment variables as JSON"
                                   FontSize="12"
                                   Foreground="{DynamicResource TextSecondary}"
                                   Margin="0,4,0,0" />
                    </StackPanel>

                    <StackPanel Grid.Column="1"
                                Orientation="Horizontal"
                                Spacing="8">
                        
                        <Border Width="6" Height="6"
                                CornerRadius="3"
                                Background="{DynamicResource AccentBrush}"
                                VerticalAlignment="Center"
                                IsVisible="{Binding SelectedEnvironment.IsDirty}" 
                                ToolTip.Tip="Unsaved changes" />
                        
                        <Button Classes="SaveButton"
                                Command="{Binding SaveEnvironmentCommand}"
                                ToolTip.Tip="Save (Ctrl+S)"
                                Width="80">
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <lucide:Lucide Icon="Save"
                                               StrokeBrush="White"
                                               Width="14" Height="14" />
                                <TextBlock Text="Save" VerticalAlignment="Center" />
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>

            <Grid Grid.Row="1" Background="{DynamicResource BgMain}">

                <Border Background="{DynamicResource BgMain}"
                        IsVisible="{Binding !HasSelectedEnvironment}">
                    <StackPanel VerticalAlignment="Center"
                                HorizontalAlignment="Center"
                                Spacing="16">
                        <lucide:Lucide Icon="Globe"
                                       StrokeBrush="{DynamicResource TextMuted}"
                                       Width="48" Height="48"
                                       HorizontalAlignment="Center" />
                        <TextBlock Text="No Environment Selected"
                                   FontSize="18"
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource TextPrimary}"
                                   HorizontalAlignment="Center" />
                        <TextBlock Text="Select an environment from the list to edit"
                                   FontSize="13"
                                   Foreground="{DynamicResource TextSecondary}"
                                   HorizontalAlignment="Center" />
                    </StackPanel>
                </Border>

                <Border IsVisible="{Binding HasSelectedEnvironment}"
                        Margin="0"
                        Background="#1E1E1E"
                        BorderThickness="0">

                    <controls:JsonBodyEditor Text="{Binding SelectedEnvironment.VariablesJson, Mode=TwoWay}"
                                             HorizontalAlignment="Stretch"
                                             VerticalAlignment="Stretch" />
                </Border>
            </Grid>
        </Grid>
    </Grid>
</UserControl>
